#!/bin/bash
# Pi Analytics Dashboard Kiosk Startup Script
# Generated by Ansible - Optimized for Pi Zero W

# Wait for display to be ready
sleep 5

# Wait for backend to be ready
echo "Waiting for backend..."
for i in {1..60}; do
    if curl -s http://localhost:5000/api/health >/dev/null 2>&1; then
        echo "Backend is ready!"
        break
    fi
    sleep 1
done

# Disable screen blanking
xset -dpms 2>/dev/null || true
xset s off 2>/dev/null || true
xset s noblank 2>/dev/null || true

# Hide cursor
unclutter -idle 1 -root &

# Start window manager
matchbox-window-manager -use_titlebar no -use_cursor no &
sleep 2

{% if display_type == 'hyperpixel_round' %}
# HyperPixel Round - Use Surf for Pi Zero W compatibility
# Surf works better than Chromium on ARMv6 architecture
if command -v surf >/dev/null 2>&1; then
    echo "Starting Surf browser (Pi Zero W compatible)..."
    exec surf -F http://localhost:5000
elif command -v midori >/dev/null 2>&1; then
    echo "Starting Midori browser..."
    exec midori -e Fullscreen -a http://localhost:5000
else
    echo "No compatible browser found for Pi Zero W!"
    echo "ARMv6 architecture requires lightweight browsers"
    exit 1
fi
{% else %}
# Standard display - can use Chromium
if command -v chromium-browser >/dev/null 2>&1; then
    exec chromium-browser \
        --kiosk \
        --noerrdialogs \
        --disable-infobars \
        --disable-session-crashed-bubble \
        --disable-features=TranslateUI \
        --disable-pinch \
        --overscroll-history-navigation=0 \
        --start-fullscreen \
        http://localhost:5000
else
    # Fallback to lightweight browser
    exec surf -F http://localhost:5000
fi
{% endif %}