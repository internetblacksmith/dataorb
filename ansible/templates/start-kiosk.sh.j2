#!/bin/bash
# Pi Analytics Dashboard - Silent Kiosk Mode
# Professional boot with no visible text

# Redirect all output for complete silence
exec > /dev/null 2>&1

# Kill any boot splash
sudo killall fbi 2>/dev/null || true

# Wait for display to be ready
sleep 5

# Wait for backend (silent check)
for i in {1..60}; do
    curl -s http://localhost/api/health >/dev/null 2>&1 && break
    sleep 1
done

# Disable screen blanking
xset -dpms 2>/dev/null || true
xset s off 2>/dev/null || true
xset s noblank 2>/dev/null || true

# Hide cursor
unclutter -idle 1 -root &

# Start window manager
matchbox-window-manager -use_titlebar no -use_cursor no &
sleep 2

{% if display_type == 'hyperpixel_round' %}
# HyperPixel Round - Use Surf for Pi Zero W
if command -v surf >/dev/null 2>&1; then
    exec surf -F http://localhost
elif command -v midori >/dev/null 2>&1; then
    exec midori -e Fullscreen -a http://localhost
else
    exit 1
fi
{% else %}
# Standard display - Use Chromium or fallback
if command -v chromium-browser >/dev/null 2>&1; then
    exec chromium-browser \
        --kiosk \
        --noerrdialogs \
        --disable-infobars \
        --disable-session-crashed-bubble \
        --disable-features=TranslateUI \
        --disable-pinch \
        --overscroll-history-navigation=0 \
        --start-fullscreen \
        http://localhost
else
    exec surf -F http://localhost
fi
{% endif %}